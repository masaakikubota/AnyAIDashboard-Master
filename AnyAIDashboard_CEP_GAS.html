<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAS Batch Runner - CEP</title>
    <link rel="stylesheet" href="assets/tokens.css">
    <link rel="stylesheet" href="assets/custom.css">
</head>
<body>
    <nav class="navbar">
        <a class="navbar-brand" href="index.html">GAS Batch Runner (CEP)</a>
    </nav>

    <main class="container">
        <div class="header-section">
            <h1>GAS実行設定 (CEP)</h1>
            <p>Google Apps Scriptをバッチ処理で連続実行します。</p>
            <form id="runner-form">
                <div class="form-group">
                    <label for="sheet-url" class="form-label">Spreadsheet URL</label>
                    <input type="url" class="form-control" id="sheet-url" value="https://docs.google.com/spreadsheets/d/19g2vepsYjMHJc5RUNnfO9UXILU7fbPpxtwc5-JddO4M/edit" required>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="start-row" class="form-label">開始行</label>
                        <input type="number" class="form-control" id="start-row" value="5" required>
                    </div>
                    <div class="form-group">
                        <label for="end-row" class="form-label">終了行</label>
                        <input type="number" class="form-control" id="end-row" value="4004" required>
                    </div>
                    <div class="form-group">
                        <label for="batch-size" class="form-label">バッチサイズ</label>
                        <input type="number" class="form-control" id="batch-size" value="20" required>
                    </div>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">実行</button>
                    <button type="button" class="btn btn-secondary" id="stop-button" disabled>停止</button>
                </div>
            </form>
        </div>

        <div class="log-section">
            <h2>実行ログ</h2>
            <div id="log-container"></div>
        </div>
    </main>

    <script>
        const form = document.getElementById('runner-form');
        const logContainer = document.getElementById('log-container');
        const executeButton = form.querySelector('button[type="submit"]');
        const stopButton = document.getElementById('stop-button');

        const GAS_URL = "https://script.google.com/macros/s/AKfycbxKcX_SnFzaKgm-Fjtx77WKylAKxjuLKNroXRurI-9YotB9AGvkZgGqzbwQ_b7to2UecA/exec";
        const TOKEN = "AnyAIDashboard_CEP";

        let shouldStop = false;

        function log(message, color = 'black') {
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `<span style="color: ${color};">[${timestamp}] ${message}</span>\n`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function extractSheetId(url) {
            const match = url.match(///d\/([a-zA-Z0-9-_]+)/);
            return match ? match[1] : null;
        }

        stopButton.addEventListener('click', () => {
            shouldStop = true;
            log('停止信号を送信しました。現在のバッチ処理が完了後に停止します。', 'orange');
            stopButton.disabled = true;
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const sheetUrl = document.getElementById('sheet-url').value;
            const spreadsheetId = extractSheetId(sheetUrl);
            
            const startRow = parseInt(document.getElementById('start-row').value, 10);
            const lastRow = parseInt(document.getElementById('end-row').value, 10);
            const batchSize = parseInt(document.getElementById('batch-size').value, 10);

            if (!spreadsheetId) {
                log('無効なSpreadsheet URLです。URLからIDを抽出できませんでした。', 'red');
                return;
            }

            if (isNaN(startRow) || isNaN(lastRow) || isNaN(batchSize)) {
                log('すべてのフィールドを正しく入力してください。', 'red');
                return;
            }

            logContainer.innerHTML = '';
            log(`Spreadsheet ID: ${spreadsheetId} を抽出しました。`, 'blue');
            log('処理を開始します...');
            executeButton.disabled = true;
            stopButton.disabled = false;
            shouldStop = false;

            let successCount = 0;
            let errorCount = 0;

            try {
                for (let start = startRow; start <= lastRow; start += batchSize) {
                    if (shouldStop) {
                        log('処理がユーザーによって中断されました。', 'orange');
                        break;
                    }

                    const end = Math.min(start + batchSize - 1, lastRow);
                    log(`バッチ処理中: ${start}行目から${end}行目`);

                    const payload = {
                        spreadsheetId,
                        token: TOKEN,
                        startRow: start,
                        endRow: end,
                    };

                    try {
                        const response = await fetch(GAS_URL, {
                            method: 'POST',
                            mode: 'no-cors',
                            cache: 'no-cache',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(payload),
                            redirect: 'follow'
                        });
                        
                        log(`  -> リクエスト成功: ${start}-${end}行`, 'green');
                        successCount++;

                    } catch (error) {
                        log(`  -> リクエストエラー: ${start}-${end}行 - ${error.message}`, 'red');
                        errorCount++;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 200)); 
                }
            } finally {
                log('--------------------', 'blue');
                log('すべての処理が完了しました。', 'blue');
                log(`成功: ${successCount}件, エラー: ${errorCount}件`, 'blue');
                executeButton.disabled = false;
                stopButton.disabled = true;
            }
        });
    </script>
</body>
</html>